<html>

<head>
<title>Hough Transform and Haar Wavelet</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript">
    var ctx;
    var img;
    var altImg;

    function initGL(canvas) 
    {
        try 
        {
            ctx = canvas.getContext("2d");
            ctx.viewportWidth = canvas.width;
            ctx.viewportHeight = canvas.height;
            ctx.clearRect (0 , 0 , canvas.width, canvas.height);
        } catch (e) { }
        if (!ctx) 
        {
            alert("Could not initialise canvas, sorry :-(\n\
                Maybe try Chome or Firefox?");
        }
    };


    function drawScene(img) 
    {
        ctx.drawImage(img,0,0,img.width,img.height);
    };

    function buildLookUpTable(radiusMin, radiusMax) 
    {
        var i = 0;
        var incDen = 4 * radiusMin;
        var radiusInc = 1;
        var lut = [[[]],[[]]];

        for (var i = 0; i < radiusMax; i++) 
        {
            lut[0][i] = [];
            lut[1][i] = []; 
        };

        // for (var tempRadius = radiusMin; tempRadius <= radiusMax; tempRadius++) 
        // {
        //     i = 0;
        //     for (var inc = 0; inc < incDen; inc+=0.1) 
        //     {
        //         var angle = (2*Math.PI * inc) / incDen;
        //         var indexR = (tempRadius - radiusMin)/radiusInc;
        //         var rcos = Math.round(tempRadius * Math.cos(angle));
        //         var rsin = Math.round(tempRadius * Math.sin(angle));
        //         if (i == 0 || ( (rcos != lut[0][indexR][i]) && (rsin != lut[1][indexR][i])) ) 
        //         {
        //             lut[0][indexR][i] = rcos;
        //             lut[1][indexR][i] = rsin;
        //             i++;
        //         };
        //     };

        // };

        for (var tempRadius = radiusMin; tempRadius <= radiusMax; tempRadius++) 
        {
            i = 0;
            for (var row = 0; row < tempRadius; row++) 
            {
                for (var col = 0; col < tempRadius; col++) 
                {
                    var dist = Math.sqrt(row*row + col*col);
                    var indexR = tempRadius - radiusMin; 
                    if ((dist <= (tempRadius + 0.5)) && (dist >= (tempRadius - 0.5) ) ) 
                    {
                        lut[0][indexR][i] = col;
                        lut[1][indexR][i] = row;
                        i++;
                    };
                };
            };
        };        

        return lut;
    };

    function houghTransform(img, imgd, thresh) 
    {

        altImg = ctx.getImageData(0,0,ctx.viewportWidth,ctx.viewportHeight);
        var altpix = altImg.data;
        var pix = imgd.data;
        var rowSize = ctx.viewportWidth;
        var colSize = ctx.viewportHeight;

        for (var row = 1; row < img.height - 1; row++) 
        {
            for (var col = 1; col < img.width - 1; col++) 
            {
                altpix[4*(row*rowSize + col) ] = 0;
                altpix[4*(row*rowSize + col)+1 ] = 0;

                altpix[4*(row*rowSize + col)+2 ] = 0;

                altpix[4*(row*rowSize + col)+3 ] = 255;
            };
        };

        var height = img.height;
        var width = img.width;
        var radiusMin = 1;
        var radiusMax = 50;

        var lut = buildLookUpTable(radiusMin, radiusMax);

        var houghValues =  [[[]]];

        for (var i = 0; i <= img.width; i++) 
        {
            houghValues[i] = [];
            for (var j = 0; j <= height; j++) 
            {
                houghValues[i][j] = [];
                for (var k = 0; k < radiusMax + 1; k++) 
                {
                    houghValues[i][j][k] = 0;
                };
            };
        };

        //Hough Transform
        for (var row = 1; row < img.height - 1; row++) 
        {
            for (var col = 1; col < img.width - 1; col++) 
            {

                for (var tempRadius = radiusMin; tempRadius <= radiusMax; tempRadius++) 
                {

                    if (pix[4*((row)*img.width+(col))] > 1) 
                    {
                        var indexR = (tempRadius - radiusMin);
                        for (var i = 0; i < lut[0][indexR].length; i++) 
                        {
                            var a = col + lut[1][indexR][i];
                            var b = row + lut[0][indexR][i];
                            if((b >= 0) && (b < height) && (a >= 0) && (a < width)) 
                            {
                                houghValues[a][b][indexR-1] = houghValues[a][b][indexR-1] + 1;
                                altpix[4*(b*rowSize + a) ] += 1;
                                altpix[4*(b*rowSize + a)+1 ] += 0;

                                altpix[4*(b*rowSize + a)+2 ] += 1;

                                altpix[4*(b*rowSize + a)+3 ] = 255;
                            }
                        };
                    };
                };
            };
        };

        //find the max radius
        var maxCounter = 0;
        var maxRs = [];

        for (var k = 0; k < radiusMax + 1; k++ ) 
        {
            for (var j = 0; j < img.height; j++) 
            {
                for (var i = 0; i < img.width; i++) 
                {
                    if (houghValues[i][j][k] > maxCounter) 
                    {
                        maxCounter = houghValues[i][j][k];
                    };
                };
            };
        };

        for (var k = 0; k < radiusMax + 1; k++ ) 
        {
            for (var j = 0; j < img.height; j++) 
            {
                for (var i = 0; i < img.width; i++) 
                {
                    if (houghValues[i][j][k] >= maxCounter-thresh) 
                    {
                        for (var row = -k; row < k; row++) 
                        {
                            for (var col = -k; col < k; col++) 
                            {
                                var dist = Math.sqrt(row*row + col*col);
                                var b = j + row;
                                var a = i + col;
                                if ((dist <= (k + 1)) && (dist >= (k - 1) ) ) 
                                {
                                altpix[4*(b*rowSize + a) ] += 0;
                                altpix[4*(b*rowSize + a)+1 ] = 255;

                                altpix[4*(b*rowSize + a)+2 ] += 0;

                                altpix[4*(b*rowSize + a)+3 ] = 255;
                                };
                            };
                        };
                    };
                };
            };
        };


        console.log(maxCounter);

        ctx.putImageData(altImg,0,height + 5);
    };


    function Reset() {
        var canvas0 = document.getElementById("canvas0");
        var canvas1 = document.getElementById("canvas1");
        ctx0 = canvas0.getContext("2d");
        imgd = ctx0.getImageData(0,0,canvas0.width,canvas0.height);
        initGL(canvas1);
        ctx.putImageData(imgd,0,0);
        //console.log("I'm reseting");
    };


    function showValue(newValue)
    {
        document.getElementById("range").innerHTML = newValue;
        var canvas0 = document.getElementById("canvas0");
        var ctx0 = canvas0.getContext("2d");
        imgd = ctx0.getImageData(0,0,canvas0.width,canvas0.height);
        houghTransform(img, imgd, newValue);
    }


    function webGLStart() {
        var canvas0 = document.getElementById("canvas0");
        var canvas1 = document.getElementById("canvas1");
        var canvas2 = document.getElementById("canvas2");
        var canvas3 = document.getElementById("canvas3");
        img = new Image();
        img.src = "img_hough_circle.png";
        var imgd;
        img.onload = function() {
            initGL(canvas0);
            canvas0.width = img.width;
            canvas0.height = img.height;
            drawScene(img);
            imgd = ctx.getImageData(0,0,canvas0.width,canvas0.height);
            initGL(canvas1);
            ctx.putImageData(imgd,0,0);
            var thresh = 6;
            houghTransform(img, imgd, thresh);
            // ErodebyN(img,imgd,17);
        };
        var img2 = new Image();
        img2.src = "img_lena.png";
        img2.onload = function() {
            initGL(canvas2);
            canvas2.width = img2.width;
            canvas2.height = img2.height;
            drawScene(img2);
            imgd = ctx.getImageData(0,0,canvas2.width,canvas2.height);
            initGL(canvas3);
        };
    };
</script>


</head>


<body onload="webGLStart();">
    <p>Image to Use: </p>

    <canvas id="canvas0" style="border: 1px solid #000000; margin-left: auto; margin-right: auto; display: block;" width="500" height="500"></canvas>

    <p>Threshold for finding circles, with the hough transform in purple and green circles represting circles found at that threshold.</p>

    <input style="padding-left=100px" type="range" min="1" max="50" value="6" step="1" onchange="showValue(this.value)" />
    <span id="range">6</span>
    <button onclick="Reset()">Back to Original</button>
    <canvas id="canvas1" style="border: 1px solid #000000; margin-left: auto; margin-right: auto; display: block;" width="500" height="500"></canvas>

    <button onclick="onOff0()">Show relevant JS code</button>
    <script type="text/javascript">
        function onOff0() {
        var onOff = document.getElementById("item0").style.display;
        if (onOff == "none") {
            document.getElementById("item0").style.display="block";
        } else{
            document.getElementById("item0").style.display="none";
        };
        };
    </script>
    <pre id="item0" style="display:none;">
        Javascript Code:
        <code>
        function buildLookUpTable(radiusMin, radiusMax) 
    {
        var i = 0;
        var incDen = 4 * radiusMin;
        var radiusInc = 1;
        var lut = [[[]],[[]]];

        for (var i = 0; i &lt; radiusMax; i++) 
        {
            lut[0][i] = [];
            lut[1][i] = []; 
        };

        for (var tempRadius = radiusMin; tempRadius &lt;= radiusMax; tempRadius++) 
        {
            i = 0;
            for (var row = 0; row &lt; tempRadius; row++) 
            {
                for (var col = 0; col &lt; tempRadius; col++) 
                {
                    var dist = Math.sqrt(row*row + col*col);
                    var indexR = tempRadius - radiusMin; 
                    if ((dist &lt;= (tempRadius + 0.5)) &amp;&amp; (dist >= (tempRadius - 0.5) ) ) 
                    {
                        lut[0][indexR][i] = col;
                        lut[1][indexR][i] = row;
                        i++;
                    };
                };
            };
        };        

        return lut;
    };

    function houghTransform(img, imgd, thresh) 
    {

        altImg = ctx.getImageData(0,0,ctx.viewportWidth,ctx.viewportHeight);
        var altpix = altImg.data;
        var pix = imgd.data;
        var rowSize = ctx.viewportWidth;
        var colSize = ctx.viewportHeight;

        for (var row = 1; row &lt; img.height - 1; row++) 
        {
            for (var col = 1; col &lt; img.width - 1; col++) 
            {
                altpix[4*(row*rowSize + col) ] = 0;
                altpix[4*(row*rowSize + col)+1 ] = 0;

                altpix[4*(row*rowSize + col)+2 ] = 0;

                altpix[4*(row*rowSize + col)+3 ] = 255;
            };
        };

        var height = img.height;
        var width = img.width;
        var radiusMin = 1;
        var radiusMax = 50;

        var lut = buildLookUpTable(radiusMin, radiusMax);

        var houghValues =  [[[]]];

        for (var i = 0; i &lt;= img.width; i++) 
        {
            houghValues[i] = [];
            for (var j = 0; j &lt;= height; j++) 
            {
                houghValues[i][j] = [];
                for (var k = 0; k < radiusMax + 1; k++) 
                {
                    houghValues[i][j][k] = 0;
                };
            };
        };

        //Hough Transform
        for (var row = 1; row &lt; img.height - 1; row++) 
        {
            for (var col = 1; col &lt; img.width - 1; col++) 
            {

                for (var tempRadius = radiusMin; tempRadius &lt;= radiusMax; tempRadius++) 
                {

                    if (pix[4*((row)*img.width+(col))] > 1) 
                    {
                        var indexR = (tempRadius - radiusMin);
                        for (var i = 0; i &lt; lut[0][indexR].length; i++) 
                        {
                            var a = col + lut[1][indexR][i];
                            var b = row + lut[0][indexR][i];
                            if((b >= 0) &amp;&amp; (b &lt; height) &amp;&amp; (a >= 0) &amp;&amp; (a &lt; width)) 
                            {
                                houghValues[a][b][indexR-1] = houghValues[a][b][indexR-1] + 1;
                                altpix[4*(b*rowSize + a) ] += 1;
                                altpix[4*(b*rowSize + a)+1 ] += 0;

                                altpix[4*(b*rowSize + a)+2 ] += 1;

                                altpix[4*(b*rowSize + a)+3 ] = 255;
                            }
                        };
                    };
                };
            };
        };

        //find the max radius
        var maxCounter = 0;
        var maxRs = [];

        for (var k = 0; k &lt; radiusMax + 1; k++ ) 
        {
            for (var j = 0; j &lt; img.height; j++) 
            {
                for (var i = 0; i &lt; img.width; i++) 
                {
                    if (houghValues[i][j][k] > maxCounter) 
                    {
                        maxCounter = houghValues[i][j][k];
                    };
                };
            };
        };

        for (var k = 0; k &lt; radiusMax + 1; k++ ) 
        {
            for (var j = 0; j &lt; img.height; j++) 
            {
                for (var i = 0; i &lt; img.width; i++) 
                {
                    if (houghValues[i][j][k] >= maxCounter-thresh) 
                    {
                        for (var row = -k; row &lt; k; row++) 
                        {
                            for (var col = -k; col &lt; k; col++) 
                            {
                                var dist = Math.sqrt(row*row + col*col);
                                var b = j + row;
                                var a = i + col;
                                if ((dist &lt;= (k + 1)) &amp;&amp; (dist >= (k - 1) ) ) 
                                {
                                altpix[4*(b*rowSize + a) ] += 0;
                                altpix[4*(b*rowSize + a)+1 ] = 255;

                                altpix[4*(b*rowSize + a)+2 ] += 0;

                                altpix[4*(b*rowSize + a)+3 ] = 255;
                                };
                            };
                        };
                    };
                };
            };
        };


        console.log(maxCounter);

        ctx.putImageData(altImg,0,height + 5);
    };
        </code>
    </pre>

    <p></p>
    <canvas id="canvas2" style="border: 1px solid #000000; margin-left: auto; margin-right: auto; display: block;" width="500" height="500"></canvas>

    <p></p>

    <canvas id="canvas3" style="border: 1px solid #000000; margin-left: auto; margin-right: auto; display: block;" width="500" height="500"></canvas>

    <br/>
    <p></p>
    <a href="http://xksteven.com/">&lt;&lt; Back to other examples</a><br />
</body>

</html>
